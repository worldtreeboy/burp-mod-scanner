package com.omnistrike.modules.exploit.omnimap.dbms;

import java.util.List;
import java.util.regex.Pattern;

/**
 * Database-specific SQL syntax for OmniMap extraction.
 * Each DBMS has unique functions for string manipulation, conditional logic,
 * time delays, error-based extraction, and schema enumeration.
 */
public interface DbmsDialect {

    /** DBMS name (e.g., "MySQL", "PostgreSQL") */
    String getName();

    /** Query to get the current database name */
    String currentDatabase();

    /** Query to list all databases */
    String listDatabases();

    /** Query to list tables in a specific database */
    String listTables(String database);

    /** Query to list columns in a specific table */
    String listColumns(String database, String table);

    /**
     * Query to dump data from a table.
     * Uses LIMIT/OFFSET or equivalent for pagination.
     */
    String dumpData(String database, String table, List<String> columns, int offset, int limit);

    /** Convert ASCII code to character (e.g., CHAR(65) → 'A') */
    String charFunction(int ascii);

    /** Extract substring (e.g., SUBSTRING(expr, pos, len) or MID/SUBSTR) */
    String substringFunction(String expr, int pos, int len);

    /** Get string length */
    String lengthFunction(String expr);

    /** Sleep/delay function for time-based blind */
    String sleepFunction(int seconds);

    /** Conditional expression: IF(cond, trueVal, falseVal) */
    String ifFunction(String condition, String trueVal, String falseVal);

    /** SQL comment suffix to terminate injected queries */
    String commentSuffix();

    /** Concatenate strings */
    String concatenate(String... parts);

    /** Error-inducing functions for error-based extraction */
    List<String> errorFunctions();

    /**
     * Return error functions available at the given level.
     * Level 1: primary functions only. Higher levels unlock more exotic functions.
     * Default implementation returns all error functions regardless of level.
     */
    default List<String> errorFunctionsForLevel(int level) {
        return errorFunctions();
    }

    /**
     * Heavy computation query as an alternative to native sleep functions.
     * Used at risk 2+ when native sleep is blocked or unavailable.
     * Returns a query expression that takes approximately `seconds` to execute.
     */
    default String heavyQuery(int seconds) {
        // Default: fall back to native sleep
        return sleepFunction(seconds);
    }

    /** Regex patterns that match DBMS-specific error messages */
    List<Pattern> errorPatterns();

    /** Query to count rows in a table */
    String countRows(String database, String table);

    /**
     * Test query for error-based detection. Must return a guaranteed non-null, non-empty
     * string value when executed as a subquery. Used during error-based detect() to
     * verify that an error function works.
     *
     * Default: currentDatabase() — works for most setups.
     * Override for DBMS where the default might return NULL (e.g., MySQL with no default DB).
     */
    default String errorTestQuery() { return currentDatabase(); }

    /**
     * Decoded start marker for error-based extraction (like sqlmap's kb.chars.start).
     * Used to reliably locate extracted data in error messages.
     * Returns null if this dialect doesn't support error-based extraction.
     */
    default String getErrorPrefixDecoded() { return null; }

    /**
     * Decoded stop marker for error-based extraction (like sqlmap's kb.chars.stop).
     */
    default String getErrorSuffixDecoded() { return null; }

    /** Separator string used between concatenated values in UNION extraction */
    default String separator() { return "0x7c"; } // '|' in hex

    /**
     * FROM clause needed for bare SELECT in UNION queries.
     * Oracle requires "FROM DUAL", all others return "".
     */
    default String unionFrom() { return ""; }

    /** Wrap a subquery for use inside blind conditions */
    default String wrapSubquery(String query) {
        return "(" + query + ")";
    }

    /** Get the ASCII value of a character at position in a string */
    default String asciiAtPosition(String expr, int pos) {
        return "ASCII(" + substringFunction(expr, pos, 1) + ")";
    }

    /**
     * Apply LIMIT/OFFSET pagination to a query.
     * Default uses MySQL/PostgreSQL/SQLite syntax: LIMIT n OFFSET n.
     * Override for DBMS with different syntax (Oracle ROWNUM, MSSQL OFFSET FETCH).
     */
    default String limitOffset(String query, int limit, int offset) {
        return query + " LIMIT " + limit + " OFFSET " + offset;
    }
}
