package com.omnistrike.modules.exploit.omnimap.technique;

import burp.api.montoya.http.message.requests.HttpRequest;

import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;

/**
 * Utility to inject payloads into HTTP request parameters.
 *
 * Encoding rules (matching how real HTTP works):
 * - URL params: URL-encoded (spaces → %20, ' → %27) — browser/server expects this
 * - Body params: URL-encoded (application/x-www-form-urlencoded spec)
 * - Cookies: RAW — Cookie header is sent as-is, encoding would break injection
 * - Headers: RAW — HTTP headers are sent as-is
 */
public class PayloadInjector {

    public static HttpRequest inject(HttpRequest request, String paramName, String paramType, String payload) {
        if (request == null || paramName == null || payload == null) return request;

        return switch (paramType.toLowerCase()) {
            case "url" -> injectUrlParam(request, paramName, payload);
            case "body" -> injectBodyParam(request, paramName, payload);
            case "cookie" -> injectCookieParam(request, paramName, payload);
            case "header" -> injectHeaderParam(request, paramName, payload);
            default -> injectUrlParam(request, paramName, payload);
        };
    }

    /**
     * REPLACE mode — like sqlmap's NEGATIVE WHERE for UNION injection.
     * Instead of APPENDING payload to existing parameter value, REPLACES the value entirely.
     * Used for UNION extraction: original value is negated (-1) so original query returns
     * 0 rows and only the UNION SELECT result appears in the response.
     */
    public static HttpRequest injectReplace(HttpRequest request, String paramName, String paramType, String payload) {
        if (request == null || paramName == null || payload == null) return request;

        return switch (paramType.toLowerCase()) {
            case "url" -> replaceUrlParam(request, paramName, payload);
            case "body" -> replaceBodyParam(request, paramName, payload);
            case "cookie" -> replaceCookieParam(request, paramName, payload);
            case "header" -> replaceHeaderParam(request, paramName, payload);
            default -> replaceUrlParam(request, paramName, payload);
        };
    }

    private static HttpRequest replaceUrlParam(HttpRequest request, String paramName, String payload) {
        String url = request.url();
        int queryStart = url.indexOf('?');
        if (queryStart < 0) {
            return request.withPath(request.path() + "?" + paramName + "=" +
                    URLEncoder.encode(payload, StandardCharsets.UTF_8));
        }

        String query = url.substring(queryStart + 1);
        String[] pairs = query.split("&");
        StringBuilder newQuery = new StringBuilder();
        boolean found = false;

        for (String pair : pairs) {
            if (newQuery.length() > 0) newQuery.append("&");
            int eq = pair.indexOf('=');
            String key = eq >= 0 ? pair.substring(0, eq) : pair;

            if (key.equals(paramName)) {
                newQuery.append(key).append("=").append(
                        URLEncoder.encode(payload, StandardCharsets.UTF_8));
                found = true;
            } else {
                newQuery.append(pair);
            }
        }

        if (!found) {
            newQuery.append("&").append(paramName).append("=").append(
                    URLEncoder.encode(payload, StandardCharsets.UTF_8));
        }

        String originalPath = request.path();
        int pathQueryIdx = originalPath.indexOf('?');
        String basePath = pathQueryIdx >= 0 ? originalPath.substring(0, pathQueryIdx) : originalPath;

        return request.withPath(basePath + "?" + newQuery);
    }

    private static HttpRequest replaceBodyParam(HttpRequest request, String paramName, String payload) {
        String body = request.bodyToString();
        if (body == null || body.isEmpty()) {
            return request.withBody(paramName + "=" + URLEncoder.encode(payload, StandardCharsets.UTF_8));
        }

        String[] pairs = body.split("&");
        StringBuilder newBody = new StringBuilder();
        boolean found = false;

        for (String pair : pairs) {
            if (newBody.length() > 0) newBody.append("&");
            int eq = pair.indexOf('=');
            String key = eq >= 0 ? pair.substring(0, eq) : pair;

            if (key.equals(paramName)) {
                newBody.append(key).append("=").append(
                        URLEncoder.encode(payload, StandardCharsets.UTF_8));
                found = true;
            } else {
                newBody.append(pair);
            }
        }

        if (!found) {
            newBody.append("&").append(paramName).append("=").append(
                    URLEncoder.encode(payload, StandardCharsets.UTF_8));
        }

        return request.withBody(newBody.toString());
    }

    private static HttpRequest replaceCookieParam(HttpRequest request, String paramName, String payload) {
        String cookieHeader = request.headerValue("Cookie");
        if (cookieHeader == null) {
            return request.withAddedHeader("Cookie", paramName + "=" + payload);
        }

        String[] cookies = cookieHeader.split(";\\s*");
        StringBuilder newCookie = new StringBuilder();
        boolean found = false;

        for (String cookie : cookies) {
            if (newCookie.length() > 0) newCookie.append("; ");
            int eq = cookie.indexOf('=');
            String name = eq >= 0 ? cookie.substring(0, eq).trim() : cookie.trim();

            if (name.equals(paramName)) {
                newCookie.append(name).append("=").append(payload);
                found = true;
            } else {
                newCookie.append(cookie.trim());
            }
        }

        if (!found) {
            newCookie.append("; ").append(paramName).append("=").append(payload);
        }

        return request.withRemovedHeader("Cookie")
                .withAddedHeader("Cookie", newCookie.toString());
    }

    private static HttpRequest replaceHeaderParam(HttpRequest request, String paramName, String payload) {
        return request.withRemovedHeader(paramName)
                .withAddedHeader(paramName, payload);
    }

    private static HttpRequest injectUrlParam(HttpRequest request, String paramName, String payload) {
        String url = request.url();
        int queryStart = url.indexOf('?');
        if (queryStart < 0) {
            return request.withPath(request.path() + "?" + paramName + "=" +
                    URLEncoder.encode(payload, StandardCharsets.UTF_8));
        }

        String path = url.substring(0, queryStart);
        String query = url.substring(queryStart + 1);
        String[] pairs = query.split("&");
        StringBuilder newQuery = new StringBuilder();
        boolean found = false;

        for (String pair : pairs) {
            if (newQuery.length() > 0) newQuery.append("&");
            int eq = pair.indexOf('=');
            String key = eq >= 0 ? pair.substring(0, eq) : pair;
            String value = eq >= 0 ? pair.substring(eq + 1) : "";

            if (key.equals(paramName)) {
                newQuery.append(key).append("=").append(value).append(
                        URLEncoder.encode(payload, StandardCharsets.UTF_8));
                found = true;
            } else {
                newQuery.append(pair);
            }
        }

        if (!found) {
            newQuery.append("&").append(paramName).append("=").append(
                    URLEncoder.encode(payload, StandardCharsets.UTF_8));
        }

        String originalPath = request.path();
        int pathQueryIdx = originalPath.indexOf('?');
        String basePath = pathQueryIdx >= 0 ? originalPath.substring(0, pathQueryIdx) : originalPath;

        return request.withPath(basePath + "?" + newQuery);
    }

    private static HttpRequest injectBodyParam(HttpRequest request, String paramName, String payload) {
        String body = request.bodyToString();
        if (body == null || body.isEmpty()) {
            return request.withBody(paramName + "=" + URLEncoder.encode(payload, StandardCharsets.UTF_8));
        }

        String[] pairs = body.split("&");
        StringBuilder newBody = new StringBuilder();
        boolean found = false;

        for (String pair : pairs) {
            if (newBody.length() > 0) newBody.append("&");
            int eq = pair.indexOf('=');
            String key = eq >= 0 ? pair.substring(0, eq) : pair;
            String value = eq >= 0 ? pair.substring(eq + 1) : "";

            if (key.equals(paramName)) {
                newBody.append(key).append("=").append(value).append(
                        URLEncoder.encode(payload, StandardCharsets.UTF_8));
                found = true;
            } else {
                newBody.append(pair);
            }
        }

        if (!found) {
            newBody.append("&").append(paramName).append("=").append(
                    URLEncoder.encode(payload, StandardCharsets.UTF_8));
        }

        return request.withBody(newBody.toString());
    }

    /**
     * Cookie injection — RAW, no URL encoding.
     * Cookie header values are sent as-is in HTTP. The server must receive
     * raw characters like ' ( ) = for SQL injection to work.
     */
    private static HttpRequest injectCookieParam(HttpRequest request, String paramName, String payload) {
        String cookieHeader = request.headerValue("Cookie");
        if (cookieHeader == null) {
            return request.withAddedHeader("Cookie", paramName + "=" + payload);
        }

        String[] cookies = cookieHeader.split(";\\s*");
        StringBuilder newCookie = new StringBuilder();
        boolean found = false;

        for (String cookie : cookies) {
            if (newCookie.length() > 0) newCookie.append("; ");
            int eq = cookie.indexOf('=');
            String name = eq >= 0 ? cookie.substring(0, eq).trim() : cookie.trim();
            String value = eq >= 0 ? cookie.substring(eq + 1) : "";

            if (name.equals(paramName)) {
                newCookie.append(name).append("=").append(value).append(payload);
                found = true;
            } else {
                newCookie.append(cookie.trim());
            }
        }

        if (!found) {
            newCookie.append("; ").append(paramName).append("=").append(payload);
        }

        return request.withRemovedHeader("Cookie")
                .withAddedHeader("Cookie", newCookie.toString());
    }

    /**
     * Header injection — RAW, no URL encoding.
     */
    private static HttpRequest injectHeaderParam(HttpRequest request, String paramName, String payload) {
        String current = request.headerValue(paramName);
        String newValue = (current != null ? current : "") + payload;
        return request.withRemovedHeader(paramName)
                .withAddedHeader(paramName, newValue);
    }
}
