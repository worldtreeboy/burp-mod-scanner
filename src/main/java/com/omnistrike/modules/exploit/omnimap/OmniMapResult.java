package com.omnistrike.modules.exploit.omnimap;

import java.util.ArrayList;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

/**
 * OmniMap extraction results â€” databases, tables, columns, and dumped rows.
 * Thread-safe for concurrent updates from parallel extraction threads.
 */
public class OmniMapResult {

    private volatile String dbms = "Unknown";
    private volatile String technique = "Unknown";
    private final List<String> databases = new ArrayList<>();
    private final Map<String, List<String>> tables = new ConcurrentHashMap<>();
    private final Map<String, List<String>> columns = new ConcurrentHashMap<>();
    private final Map<String, List<Map<String, String>>> data = new ConcurrentHashMap<>();
    private volatile int requestCount = 0;
    private volatile long startTime = System.currentTimeMillis();
    private volatile long elapsedMs = 0;

    public String getDbms() { return dbms; }
    public void setDbms(String dbms) { this.dbms = dbms; }

    public String getTechnique() { return technique; }
    public void setTechnique(String technique) { this.technique = technique; }

    public synchronized List<String> getDatabases() { return new ArrayList<>(databases); }
    public synchronized void addDatabase(String db) {
        if (!databases.contains(db)) databases.add(db);
    }
    public synchronized void setDatabases(List<String> dbs) {
        databases.clear();
        databases.addAll(dbs);
    }

    public List<String> getTables(String database) {
        return tables.getOrDefault(database, new ArrayList<>());
    }
    public void setTables(String database, List<String> tableList) {
        tables.put(database, new ArrayList<>(tableList));
    }

    public List<String> getColumns(String dbTable) {
        return columns.getOrDefault(dbTable, new ArrayList<>());
    }
    public void setColumns(String dbTable, List<String> colList) {
        columns.put(dbTable, new ArrayList<>(colList));
    }

    public List<Map<String, String>> getData(String dbTable) {
        return data.getOrDefault(dbTable, new ArrayList<>());
    }
    public void addRow(String dbTable, Map<String, String> row) {
        data.computeIfAbsent(dbTable, k -> new ArrayList<>()).add(new LinkedHashMap<>(row));
    }

    public int getRequestCount() { return requestCount; }
    public synchronized void incrementRequestCount() { requestCount++; }

    public long getElapsedMs() { return elapsedMs; }
    public void setElapsedMs(long ms) { this.elapsedMs = ms; }

    public long getStartTime() { return startTime; }
    public void setStartTime(long startTime) { this.startTime = startTime; }

    /** Returns all table keys across all databases */
    public Map<String, List<String>> getAllTables() { return new LinkedHashMap<>(tables); }
    public Map<String, List<String>> getAllColumns() { return new LinkedHashMap<>(columns); }
    public Map<String, List<Map<String, String>>> getAllData() { return new LinkedHashMap<>(data); }
}
